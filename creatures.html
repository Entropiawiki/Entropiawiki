<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://bootswatch.com/5/vapor/bootstrap.min.css" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css">

    <title>Mob Table</title>
</head>

<body>
<!-- Container for including the navbar -->
<div id="navbarContainer"></div>

<div class="container mt-5">
    <h2>Mob Table</h2>

    <table id="mobTable" class="table table-dark table-striped">
        <thead>
        <tr>
            <th scope="col">Name</th>
            <th scope="col">Location</th>
            <th scope="col">Drops</th>
        </tr>
        </thead>
        <tbody>
        <tr class="table-dark">
            <th scope="row">Dark</th>
        </tr>
        </tbody>
    </table>
</div>

<script src="s/navbar.js"></script>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>

<script>
    $(document).ready(function () {
        // Fetch mob data from the server
        $.ajax({
            url: '/api/mobs',
            method: 'GET',
            dataType: 'json',
            success: function (mobData) {
                console.log('Fetched mob data:', mobData);

                // Fetch planet data from the server
                $.ajax({
                    url: '/api/planets',
                    method: 'GET',
                    dataType: 'json',
                    success: function (planetData) {
                        console.log('Fetched planet data:', planetData);

                        // Fetch loot data from the server
                        $.ajax({
                            url: '/api/loot',
                            method: 'GET',
                            dataType: 'json',
                            success: function (lootData) {
                                console.log('Fetched loot data:', lootData);

                                // Map MobID to loot names in mob data
                                mobData.forEach(function (mob) {
                                    const matchingLoot = lootData.filter(loot => loot.MobID === mob.ID);
                                    mob.LootNames = matchingLoot.map(loot => loot.drop_name);
                                });

                                console.log('Combined mob data with loot:', mobData);

                                // Map planet ID to planet name in mob data
                                mobData.forEach(function (mob) {
                                    const matchingPlanet = planetData.find(planet => planet.ID === mob.PlanetID);
                                    mob.PlanetName = matchingPlanet ? matchingPlanet.Name : 'Unknown Planet';
                                });

                                // Initialize DataTable with the combined data
                                $('#mobTable').DataTable({
                                    data: mobData,
                                    columns: [
                                        { data: 'MobName' },
                                        { data: 'PlanetName' },
                                        {
                                            data: null,
                                            render: function (data, type, row) {
                                                return row.LootNames ? row.LootNames.join(', ') : 'No drops';
                                            }
                                        }
                                    ],
                                    paging: true,
                                    autoWidth: true,
                                    ordering: true,
                                    pagingType: "full",
                                    dom: '<"top"f>rt<"bottom"lip><"clear">',
                                    paging: true,
                                    lengthMenu: [ [10, 25, 50, -1], [10, 25, 50, "All"] ],
                                    pageLength: 20,
                                });
                            },
                            error: function (error) {
                                console.error('Error fetching loot data:', error);
                            }
                        });
                    },
                    error: function (error) {
                        console.error('Error fetching planet data:', error);
                    }
                });
            },
            error: function (error) {
                console.error('Error fetching mob data:', error);
            }
        });
    });
</script>
</body>

</html>
